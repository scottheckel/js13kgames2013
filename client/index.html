<!DOCTYPE html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script>
window.$ = function(selector) {
	var els = selector[0] == '#' ? [document.getElementById(selector.substring(1))] : document.getElementsByClassName(selector);
	return {
		on: function(eventName, handler) {
			var index = 0,
				el;
			for(;index < els.length;index++) {
				el = els[index];
				if(el.addEventListener) {
					el.addEventListener(eventName, handler, false);
				} else {
					el.attachEvent('on' + eventName, handler);
				}
			}
		},
    attr: function(name, value) {
      var index = 0,
          el;
      for(;index<els.length;index++) {
        els[index].setAttribute(name, value);
      }
    },
    template: function(data) {
      var index = 0;
      return els[0].innerHTML.replace(/\{\{(\w*)\}\}/g, function(m,key){return data.hasOwnProperty(key)?data[key]:"";});
    }
	};
};
</script>
<script>
function drawMap(canvas, game) {
  var max = game.mapSize,
      min = -max,
      x = min,
      y = min,
      size = 30
      width = size * 2,
      horiz = 3/4 * width,
      height = Math.sqrt(3)/2 * width,
      vert = height,
      offsetX = vert * (max + 1),
      offsetY = offsetX,
      context = canvas.getContext('2d');
  var coordToPixel = function(xx, yy) {
    return {x:xx*horiz,y:yy*vert+xx*vert/2};
  };
  var drawHex = function(xx, yy) {
    var i = 0,
        center = coordToPixel(xx,yy),
        angle, xI, yI;
    context.beginPath();
    for(;i<=6;i++) {
      angle = 2 * Math.PI / 6 * i;
      xI = center.x + size * Math.cos(angle) + offsetX;
      yI = center.y + size * Math.sin(angle) + offsetY;
      if(i==0) {
        context.moveTo(xI,yI);
      } else {
        context.lineTo(xI,yI);
      }
    }
    context.stroke();
  };
  for(;x<=max;x++) {
    for(y=min;y<=max;y++) {
      if(Math.abs(x+y)<=max) {
        drawHex(x,y);
      }
    }
  }
  var k, e, pos;
  for(k in game.entities) {
    e = game.entities[k];
    pos = coordToPixel(e.x, e.y);
    context.fillText(e.type == 0 ? "p" : "s", pos.x + offsetX, pos.y + offsetY);
  }
}
</script>
</head>
<body>
<div id="headerWrapper">
  Connecting...
</div>
<div id="welcomeWrapper">
  <ul id="gamesList">

  </ul>
  <button class="createGameBtn">Create New Game</button>
</div>
<div id="gameWrapper" style="display:none">
  <ul id="usersList">
  </ul>
  <ul id="messagesList">
  </ul>
  <button id="startGameBtn">Start Game</button>
  <canvas id="gameCanvas" width="800" height="800">
  </canvas>
</div>
<script id="template-gamesListItem" type="template">
<li class="game-item" data-id="{{id}}">Game {{id}} by {{host}} ({{count}} players)</li>
</script>
<script id="template-welcome" type="template">
Welcome, {{id}}! This is a game created for the js13kgames competition
</script>
<script id="template-usersListItem" type="template">
<li>User: {{id}}</li>
</script>
<script id="template-messagesListItem" type="template">
<li>{{msg}}</li>
</script>
<script>
var STATE_WELCOME = 0,
    STATE_GAME = 1;
(function() {
  var socket = io.connect('http://localhost:8080'),
      state = STATE_WELCOME,
      me = null,
      inG = null;

  function refreshUserList(users) {
    var html = '';
    users.forEach(function(user) {
      html += $('#template-usersListItem').template(user);
    });
    usersList.innerHTML = html;
  }

  function onStartGame() {
    $('#startGameBtn').attr('disabled', 'disabled');
    socket.emit('startGame', {gameId:inG.id});
  }

  $('createGameBtn').on('click', function() {
    socket.emit(
      'createGame',
      {'user':me},
      function(data) {
        if(data.success) {
          inG = data.game;
          welcomeWrapper.style.display = 'none';
          gameWrapper.style.display = 'block';
          refreshUserList(data.game.players);
          $('#startGameBtn').on('click', onStartGame);
          //drawMap(gameCanvas, data.game);
        } else {
          /* TODO: SH - Can't create */
        }
      }
    );
  });
  socket.on('connected', function(data) {
    me = data;
    headerWrapper.innerHTML = $('#template-welcome').template(data);
  });
  socket.on('refreshGames', function(data) {
    var html = '',
        index = 0;
    for(;index<data.length;index++) {
      html += $('#template-gamesListItem').template({id: data[index].id, host: data[index].host.id, count: data[index].count});
    }
    gamesList.innerHTML = html;
    $('game-item').on('click', function() {
      var gameId = this.getAttribute('data-id');
      socket.emit('joinGame',
        {'gameId':gameId,'user':me},
        function(data) {
          if(data.success) {
            inG = data.game;
            welcomeWrapper.style.display = 'none';
            gameWrapper.style.display = 'block';
            refreshUserList(data.game.players);
          } else {
            /* TODO: SH - Can't join */
          }
        }
      );
    });
  });
  socket.on('refreshUsersList', function(data) {
    refreshUserList(data);
  });
  socket.on('updateMessages', function(data) {
    var html = '',
        index = 0;
    for(;index<data.length;index++) {
      html += $('#template-messagesListItem').template(data[index]);
    }
    messagesList.innerHTML = html;
  });
  socket.on('gameStarted', function(data) {
    drawMap(gameCanvas, data.game);
  });
})();
</script>
</body>
</html>